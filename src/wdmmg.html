<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="m.okfn.org/kforge/css/master.css" type="text/css" />
    <script type="text/javascript" src="jquery-1.4.2.js"></script>
    <script type="text/javascript" src="jquery.json-2.2.js"></script>
    <script type="text/javascript" src="jquery.tablesorter-2.0.3.js"></script>
    <script language="javascript" type="text/javascript" src="Jit-1.1.3/jit.js"></script>
    <link type="text/css" href="treemap.css" rel="stylesheet" />
    <script type="text/javascript" src="wdmmg.js"></script>

    <script type="text/javascript">
    function debug(message) {
      var console = window['console'];
      if (console && console.log) {
        console.log(message);
      }
    }

    $(document).ready(function(){
      function loadTreeData(data) {
        var _treedata = {
          "id": "root",
          "name": "root",
          "data": { "$area": 0 },
          "children": []
        };
        // data.metadata.axes 
        var total = 0;
        $.each(data.results, function(i,item) {
          var amount = item[1][0];
          amount = amount / 1000000000;
          var newnode = {
            "id": item[0][0],
            "name": item[0][0],
            "data": { "$area": amount },
            "children": []
          };
          total = total + amount;
          _treedata.children.push(newnode);
        });
        _treedata.data['$area'] = total;
        return $.toJSON(_treedata);
      }

      function loadAggregate(data) {
        var _ourtable = $("#results");
        _ourtable.append($('<thead><tr><th>Dept</th><th>Region</th><th>Amount</th></tr></thead>'));
        _tbody = $('<tbody></tbody>');

        $.each(data.results, function(i,item){
          // _ourtable.append($('<tr></tr>').append($("<td></td>").append('' + item[0])));
          var _newrow = $("<tr></tr>");
          _newrow.append($('<td></td>').append('' + item[0][0]));
          _newrow.append($('<td></td>').append('' + item[0][1]));
          _newrow.append($('<td></td>').append('' + item[1]));
          _tbody.append(_newrow);
        });

        _ourtable.append(_tbody);
        _ourtable.tablesorter({
          sortList: [[0,0],[1,0]]
        });
      }

      $("#visualize a").click(function(e){
        // stop normal link click
        e.preventDefault();
        
        // will not work because wdmmg does not support json callback atm
        var dept_region_url = "http://data.wheredoesmymoneygo.org/api/aggregate?slice=cra&exclude-spender=yes&breakdown-dept=yes&breakdown-region=yes&start_date=2004-05&end_date=2004-05&jsoncallback=?";
        var dept_url = "http://data.wheredoesmymoneygo.org/api/aggregate?slice=cra&exclude-spender=yes&breakdown-dept=yes&start_date=2004-05&end_date=2004-05&jsoncallback=?";
        // local copy
        apiurl = 'wdmmg.sample.json';
        debug(apiurl);

        $.getJSON(apiurl, function(data){
          loadAggregate(data);
        });

        apiurl2 = 'wdmmg.dept.json';
        debug(apiurl2);
        $.getJSON(apiurl2, function(data){
          var treedata = loadTreeData(data);
          createTreeMap(treedata, 'infovis');
        });
      });
    });
    </script>

    <link rel="stylesheet" href="wdmmg.css" type="text/css">
  </head>
  <body>
    <h1>Where Does My Money Go - Dept</h1>
    <p>Playing around with <a href="http://www.wheredoesmymoneygo.org/">WDMMG</a></p>

    <p id="visualize">
      <a href="http://data.wheredoesmymoneygo.org/">Visualize by Department</a>
    </p>

    <h2>Treemap</h2>
    <div id="infovis"></div>    

    <h2>Tabular Results</h2>
    <table id="results">
    </table>
  </body>
</html>

