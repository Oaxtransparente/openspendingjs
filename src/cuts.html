<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="http://assets.okfn.org/kforge/css/master.css" type="text/css" />
    <link rel="stylesheet" href="http://m.okfn.org/kforge/css/master.css" type="text/css" />
    <link rel="stylesheet" href="wdmmg.css" type="text/css">

    <script type="text/javascript" src="jquery-1.4.2.js"></script>
    <script type="text/javascript" src="jquery.json-2.2.js"></script>
    <script type="text/javascript" src="jquery.tablesorter-2.0.3.js"></script>

    <script language="javascript" type="text/javascript" src="Jit-1.1.3/jit.js"></script>
    <link type="text/css" href="treemap.css" rel="stylesheet" />
    <script type="text/javascript" src="wdmmg.js"></script>

    <script type="text/javascript">
    $(document).ready(function(){
      function loadTreeData(data, deficit) {
        function make_label(name, amount) {
          return name + " (&pound;" + amount + "bn)";
        }
        var _treedata = {
          "id": "root",
          "name": make_label("Total Deficit to Fill", deficit),
          "data": { "$area": 0 },
          "children": []
        };
        // data.metadata.axes 
        var total = 0;
        $.each(data.feed.entry, function(i,entry) {
          var amount = parseFloat(entry.gsx$amountbn.$t);
          var color = "0"; 
          var increaseorcut = entry.gsx$increaseorcut.$t.toLowerCase();
          if (increaseorcut == "cut") {
            color = "40"; 
          }
          var newnode = {
            "id": i,
            "name": make_label(entry.title.$t, amount),
            "data": { "$area": amount, "$color": color},
            "children": []
          };
          total = total + amount;
          // ensure we never over-fill
          if (total < deficit) {
            _treedata.children.push(newnode);
          }
        });
        // add a child to represent the area not there ...
        var notyetfilled = Math.max(deficit-total,0);
        var newnode = {
          "id": 'thehole',
          "name": make_label('Yet to be filled...', notyetfilled),
          "data": { "$area": notyetfilled, "$color": "50"},
          "children": []
        };
        _treedata.children.push(newnode);
        _treedata.data['$area'] = Math.max(deficit,total);
        return $.toJSON(_treedata);
      }

      function makeTable(data) {
        var _ourtable = $("#results");
        _ourtable.append($('<thead><tr><th>Description</th><th>Amount (&pound;bn)</th><th>Increase or Cut</th></tr></thead>'));
        _tbody = $('<tbody></tbody>');

        $.each(data.feed.entry, function(i,item){
          var _newrow = $("<tr></tr>");
          _newrow.append($('<td></td>').append('' + item.gsx$description.$t));
          _newrow.append($('<td></td>').append('' + item.gsx$amountbn.$t));
          _newrow.append($('<td></td>').append('' + item.gsx$increaseorcut.$t));
          _tbody.append(_newrow);
        });

        _ourtable.append(_tbody);
        _ourtable.tablesorter({
          sortList: [[0,0],[1,0]]
        });
      }

      function visualizeDeficit() {
        var deficit = parseFloat($('input.deficit')[0].value);
        var apiurl = 'http://spreadsheets.google.com/feeds/list/0Ah8UkI7xG7eWdDJfM2gyZDVaSlJ3dHZzR1JJWF9tekE/od6/public/values?alt=json-in-script&callback=?'
        // var apiurl = 'cuts-gdocs.js';
        $.getJSON(apiurl, function(data){
          var treedata = loadTreeData(data, deficit);
          createTreeMap(treedata, 'infovis', 'Amount &pound;bn');
          makeTable(data);
        });
      }

      $("form").bind("submit", function() {
        visualizeDeficit();
        return false;
      })

      visualizeDeficit();
    });
    </script>
    <style type="text/css">
      h2 { 
        text-align: center
      }

      form.deficit {
        text-align: center;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <h1><a href="http://www.wheredoesmymoneygo.org/">Where Does My Money Go?</a> - <a href="http://www.wheredoesmymoneygo.org/cuts/">Visualising the Cuts</a></h1>

    <h2>
      Filling the Gap (<a href="https://spreadsheets.google.com/ccc?key=0Ah8UkI7xG7eWdDJfM2gyZDVaSlJ3dHZzR1JJWF9tekE">Source Data</a>)
    </h2>
    <form class="deficit">
      <label>Deficit Gap</label>
      <input style="width: 30px;" type="text" name="deficit" value="40" class="deficit" />
      <input type="submit" name="Update" />
    </form>

    <div id="infovis"></div>

    <h2>Cuts: The Options</h2>
    <table id="results">
    </table>
  </body>
</html>

