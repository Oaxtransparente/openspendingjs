<html>
<head>
	<title>world map of openspending datasets</title>
	<script type="text/javascript" src="../../lib/vendor/jquery.js"></script>
	<script type="text/javascript" src="../../lib/vendor/raphael.js"></script>
	<script type="text/javascript" src="../../lib/vendor/kartograph/kartograph.min.js"></script>
	<script type="text/javascript" src="../../lib/vendor/chroma.pack.min.js"></script>
	<script type="text/javascript">

$(function() {

	var map = $K.map('#map'),
		colscale = new chroma.ColorScale({
    		colors: chroma.brewer.Blues,
    		limits: [-2,-1,0,1,2,3,4,5,6,7]
		}); 
		
	map.loadMap('world.svg', function(map) {
		
		$.ajax({
			url: 'datasets.json',
			success: function(datasets) {
		
				var i,j,iso2,countries = {},d1 = {};
				for (i=0;i<datasets.length;i++) {
					for (j=0;j<datasets[i].territories.length;j++) {
						iso2 = datasets[i].territories[j];
						if (!countries.hasOwnProperty(iso2)) {
							countries[iso2] = { count: 0, datasets: [] };
							d1[iso2] = 0;
						}
						d1[iso2]++;
						countries[iso2].count++;
						countries[iso2].datasets.push(datasets[i]);
					}
				}
				
				map.addLayer({
					id: 'regions',
					className: 'bg',
					filter: function(d) {
						return !countries.hasOwnProperty(d.iso2);
					}
				});
				
				map.addLayer({
					id: 'regions',
					key: 'iso2',
					filter: function(d) {
						return countries.hasOwnProperty(d.iso2);
					}
				});
				
				map.choropleth({
					data: d1,
					colors: function(d) {						
						if (d === null) return '#e3e3e3';
						return colscale.getColor(d);
					},
					duration: 300
				});
				
			}
		});
	});

});

	</script>
	<style type="text/css">
body { background: #f9f9f9; }
#wrap {
	width: 944px; margin: 0 auto;
	background: #fff;
}
#map {
	width: 640px; height: 370px;
}
#map svg path.regions {
	stroke: #fff;
	stroke-width: 0.3px;
}
#map svg path.regions:hover {
	fill: #c00;
	cursor: pointer;
}
#map svg path.bg {
	stroke: #ddd;
	fill: #ddd;
}
	</style>
</head>
<body>
	<div id="wrap">
		<div id="map">

		</div>
	</div>
</body>
</html>
